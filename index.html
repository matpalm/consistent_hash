<html>
<head>
  <style type="text/css">
    body {background-color:#111111; color:#cceedd}
    h1,h2,h3 {font-weight:900}
    .r {color:#ff0000;}
    .y {color:#ccff00;}
    .c {color:#00ff77;}
    .b {color:#0077ff;}
    .p {color:#cc00ff;}
  </style>
</head>
<title>visualising the consistent hash</title>
<body>

<hr/>
  <h1>visualising the consistent hash</h1>

<hr/>
  <h2>the resource allocation problem</h2>

  <p>
    consider the problem of allocating N resources across M servers (N &gt;&gt; M)
  </p>

<hr/>
  <h3>modulo hash</h3>

  <p>
    a common approach is the straight forward modulo hash...
  </p>
  <p>
    if we have 4 servers; <pre>servers = [server0, server1, server2, server3]</pre>
    we can allocate a resource to a server by simply
  </p>
  <p>
    <ol>
      <li>hashing the resource; <pre>hash(resource) = 54</pre></li>
      <li>reducing modulo 4; <pre>54 % 4 = 2</pre></li>
      <li>allocating to that numbered server; <pre>servers[2] = server2</pre></li>
    </ol>
  </p>

<p>
  we can visualise how this scheme maps resources to servers by allocating a colour to each server; 
  <span class="r">server0 </span> 
  <span class="y">server1 </span> 
  <span class="c">server2 </span> 
  <span class="b">server3 </span> 
</br>
and, assuming we are hashing to a value between 0 and 99, draw the following chart ...
</p>

<p>
  <img src="mod_4.png"></br>
</p>

<p>
... where the colour of the <i>n</i><sup>th</sup> column represents which server a resource hashing to <i>n</i> would be allocated to.
</p>

<p>
this hashing scheme is nice for a common of reasons
<ol>
<li>it's very simple</li>
<li>it allocates resources evenly across the servers (assuming you have a good hashing function the resource)</li>
</ol>
</p>

<p>
however it has one big drawback; what happens when you change the number of servers?</br>
eg due to extra load we have to add another server; <span class="p">server4</span>
</p>

<p>
we then have to switch from modulo 4 to modulo 5</br>
which means that a resource that used to hash to server2 ... 
<pre>
54 % 4 = 2
</pre>
now hashs to server4 ...
<pre>
54 % 5 = 4
</pre>
</p>

<p>
in fact if we compare the difference in the hashing we get the following ...
</p>

<p>
  <img src="mod_4.png"></br>
  <img src="mod_45_diff.png"></br>
  <img src="mod_5.png"></br>
</p>

<p>
... where the top bar represents the allocation with 4 servers</br>
the bottom bar represents the allocation with 5 servers,</br>
and white areas between represents cases where a resource has changed which server is was allocated to
</p>

<p>
this is pretty bad in terms of reallocation; a whooping <i>80%</i> of the resources have changed which server they are assigned to.</br>
</p>

<hr/>
<h3>divisor hash</h3>

<p>
how about instead of modulo arithmetic we try divisor instead?
</p>

<p>
considering 4 servers again we allocate a resource by 
    <ol>
      <li>hashing the resource; <pre>hash(resource) = 54</pre></li>
      <li>reducing divisor 25 (25=100/4; ie hash max / number servers); <pre>54 / (100/4) = 2</pre></li>
      <li>allocating to that numbered server; <pre>servers[2] = server2</pre></li>
    </ol>
</p>

<p>
 as before we can visualise how this scheme maps resources to servers by allocating a colour to each server; 
  <span class="r">server0 </span> 
  <span class="y">server1 </span> 
  <span class="c">server2 </span> 
  <span class="b">server3 </span> 
</br>
and, assuming we are hashing to a value between 0 and 99, this time draw the following chart ...
</p>

<p>
  <img src="div_4.png"></br>
</p>

<p>
and, again as last time, if we get a 5th server <span class="p">server4</span> we can see how the resources are reallocated ...
</p>

<p> 
  <img src="div_4.png"></br>
  <img src="div_45_diff.png"></br>
  <img src="div_5.png"></br>
</p>

<p>
this time we only 50% reallocation, instead of 80%, so that's an improvement.</br>
we also continue to spread the resources evenly across the servers so we haven't lost anything there</br>
</p>

<p>
but of course, we can do better!
</p>

<hr/>
<h3>consistent hash</h3>

<p>
in a consistent hash we associate ranges of the hash space to servers by first hashing the servers themselves.
</p>

<p>
hashing 4 servers into the range 0 to 90107 (a smallish prime) gives ...</br>

  <span class="r">server0 => 67981, </span> 
  <span class="y">server1 => 24530, </span> 
  <span class="c">server2 => 71186, </span> 
  <span class="b">server3 => 27735</span> 

</p>

<p>
... which can be converted into the ranges ...</br>
  <span class="y">server1 => (0, 24530), </span> 
  <span class="b">server3 => (24531, 27735)</span> 
  <span class="r">server0 => (27736, 67981), </span> 
  <span class="c">server2 => (67982, 71186), </span> 
  <span class="y">server1 => (71186, 90106), </span> 
</p>

<p>
visually represented as ...
</p>

<p>
  <img src="ch_4_1slots.png"></br>
</p>

<p>
allocation of a resource to a server is simply done by hashing the resource and see which range it falls into.
</p>

<p>
adding a 5th server is a simple case of hashing the new server; <span class="p">server4 => 74391</span> and adjusting the ranges.
</p>

<p>
  <img src="ch_4_1slots.png"></br>
  <img src="ch_45_diff_1slots.png"></br>
  <img src="ch_5_1slots.png"></br>
</p>

<p>
we can see how this scheme ensures that as many resources as possible retain their original server allocation.
</p>

<p>
however there's a pretty obvious problem; where as the previous methods divided the hash space evenly this method is way off.</br>
but luckily there's a pretty simple fix; simply hash each server multiple times
</p>

<p>
if we hash each server 5 times, by using 5 different hash functions, we get something the following allocations
</p>

<p>
    <img src="ch_5_5slots.png"></br>
    <img src="ch_45_diff_5slots.png"></br>
    <img src="ch_4_5slots.png"></br>
  </p>

<p>
1 slot
server0 => 0.44665 server1 => 0.27223 server2 => 0.24555 server3 => 0.03557

5 slots
server0 => 0.23500 server1 => 0.22686 server2 => 0.25426 server3 => 0.28387 

</p>

  <hr/>

  <p>
    <pre>
      20 slots each
      server0 => 0.20227 server1 => 0.21933 server2 => 0.20783 server3 => 0.16521 server4 => 0.20536  avg err 0.014 (0.20)
    </pre>
    <img src="ch_5_5slots.png"></br>
    <img src="ch_5_5slots_server4x2.png"/>
    <pre>
      20 slots for server0 to server3, 40 for server4
      server0 => 0.18551 server1 => 0.20712 server2 => 0.16547 server3 => 0.11561 server4 => 0.32629  avg err 0.053 (0.16)
    </pre>
  </p>
</body>
</html>
